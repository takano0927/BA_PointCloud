# クラス構成とアーキテクチャ

## システム全体構成

BA_PointCloudRendererは、以下の主要なコンポーネントで構成されています：

1. **CloudController**: ポイントクラウドセットの管理
2. **CloudData**: データ構造とメタデータ管理
3. **Loading**: データ読み込みとレンダリング処理
4. **ObjectCreation**: メッシュ設定とオブジェクト生成
5. **Controllers**: カメラとUI制御
6. **DataStructures**: 効率的なデータ構造実装
7. **Edl**: Eye Dome Lighting実装
8. **Utility**: ユーティリティ関数

## CloudController 名前空間

### AbstractPointCloudSet（抽象基底クラス）
```
役割: ポイントクラウドセットの基本機能を定義
主要機能:
- 複数のポイントクラウドの統合管理
- バウンディングボックス計算と管理
- 原点移動機能（moveCenterToTransformPosition）
- メッシュ設定の管理
- 子クラス: StaticPointCloudSet, DynamicPointCloudSet
```

### StaticPointCloudSet
```
役割: 小規模ポイントクラウド向けの静的レンダリング
特徴:
- 全ポイントを一度に読み込み
- シンプルな実装
- メモリ使用量が多いが高速表示
- StaticRendererを使用
```

### DynamicPointCloudSet
```
役割: 大規模ポイントクラウド向けの動的レンダリング
特徴:
- カメラ位置ベースの部分読み込み
- ポイント予算システム
- Level of Detail制御
- V2Rendererを使用
- 設定パラメータ:
  - pointBudget: 同時表示ポイント数上限
  - minNodePixelSize: 最小ノードサイズ
  - cacheSize: キャッシュサイズ
```

### PointCloudLoader
```
役割: 単一ポイントクラウドの読み込み管理
主要機能:
- Potreeフォーマットの解析
- メタデータ読み込み（cloud.js, metadata.json）
- 階層構造の構築
- StreamingAssetsサポート
- ローカル/リモートファイル対応
- 設定オプション:
  - cloudPath: ポイントクラウドパス
  - loadOnStart: 自動読み込み設定
  - streamingAssetsAsRoot: StreamingAssets相対パス
```

### DirectoryLoader
```
役割: 複数ポイントクラウドの一括読み込み
機能:
- ディレクトリ内の全ポイントクラウドを検索
- 各ポイントクラウド用のLoaderを自動生成
- エディタ専用機能
```

### Preview
```
役割: エディタでのプレビュー表示
機能:
- バウンディングボックス表示
- 低解像度ポイント表示
- プレビュー更新機能
```

## CloudData 名前空間

### Node
```
役割: 八分木ノードの実装
データ構造:
- name: ノード識別子（例: "r073"）
- boundingBox: ノードの空間範囲
- children[8]: 子ノード配列
- parent: 親ノード参照
- verticesToStore: 頂点データ
- colorsToStore: 色データ
- gameObjects: 関連GameObjectリスト
- level: 階層レベル
- pointCount: ポイント数
- byteOffset, byteSize: ファイル内位置情報
```

### PointCloudMetaData
```
役割: ポイントクラウドメタデータ管理
対応フォーマット:
- Potree v1.7 (PointCloudMetaDataV1_7)
- Potree v1.8 (PointCloudMetaDataV1_8)
- Potree v2.0 (部分対応)
含まれる情報:
- version: フォーマットバージョン
- octreeDir: 八分木データディレクトリ
- boundingBox: 全体バウンディングボックス
- tightBoundingBox: タイトバウンディングボックス
- pointAttributes: ポイント属性情報
- spacing: ポイント間隔
- scale: スケール値
- offset: オフセット値
```

### BoundingBox
```
役割: 軸平行バウンディングボックス
特徴:
- double精度での計算
- Unity Boundsとの相互変換
- 座標系変換サポート（Y-Z軸交換）
- 範囲チェック機能
- 原点移動対応
```

### Vector3d
```
役割: 高精度3Dベクトル
機能:
- double精度の3D座標
- Vector3との相互変換
- 基本的な数学演算
```

## Loading 名前空間

### AbstractRenderer（インターフェース）
```
定義機能:
- StartRenderer(): レンダラー開始
- StopRenderer(): レンダラー停止
- UpdateRenderer(): 更新処理
- AddNode(): ノード追加
- RemoveNode(): ノード削除
- Shutdown(): 終了処理
```

### StaticRenderer
```
役割: 静的レンダリング実装
処理フロー:
1. 全階層のノードを列挙
2. バックグラウンドでポイントデータ読み込み
3. メインスレッドでGameObject作成
4. 一度に全て表示
```

### V2Renderer
```
役割: 動的レンダリング実装
アーキテクチャ:
- メインスレッド: GameObject管理
- TraversalThread: ノード巡回処理
- LoadingThread: データ読み込み処理

処理フロー:
1. カメラ情報取得
2. 表示すべきノードを判定
3. 必要なデータを非同期読み込み
4. GameObjectを動的生成/削除
5. フレームごとに更新
```

### V2TraversalThread
```
役割: ノード巡回処理の専用スレッド
機能:
- カメラ位置・方向の解析
- ノードの表示優先度計算
- LOD判定
- 表示ノードリストの更新
```

### V2LoadingThread
```
役割: データ読み込み専用スレッド
機能:
- ポイントデータの非同期読み込み
- バイナリファイル解析
- メモリ効率的な処理
- キャッシュとの連携
```

### V2Cache
```
役割: 効率的なキャッシュシステム
機能:
- LRU (Least Recently Used) アルゴリズム
- メモリ使用量制御
- 高速アクセス
```

### CloudLoader
```
役割: ファイル読み込みユーティリティ
サポート機能:
- Potree形式の解析
- HTTP/HTTPSダウンロード
- ローカルファイルアクセス
- エラーハンドリング
```

## ObjectCreation 名前空間

### MeshConfiguration（抽象基底クラス）
```
役割: ポイントレンダリング方式の定義
共通機能:
- ポイントサイズ設定
- 材質設定
- バウンディングボックス表示設定
- 実行時設定変更
```

### DefaultMeshConfiguration
```
役割: 標準的なメッシュ設定
設定項目:
- pointSize: ポイントサイズ
- screenSize: スクリーンサイズ基準フラグ
- renderCamera: レンダリング用カメラ
- interpolationMode: 補間モード
- circleShader: 円形シェーダー
- quadShader: クワッドシェーダー
```

### PointMeshConfiguration
```
役割: シンプルなポイントレンダリング
特徴:
- 最低限の設定
- 高速処理
- ピクセル単位での表示
```

## DataStructures 名前空間

### ThreadSafeQueue<T>
```
役割: スレッドセーフなキュー実装
特徴:
- マルチスレッド対応
- ロックベースの同期
- 高性能
```

### HeapPriorityQueue<T>
```
役割: ヒープベースの優先度付きキュー
用途:
- ノードの優先度管理
- 効率的な最優先要素取得
```

### RandomAccessQueue<T>
```
役割: ランダムアクセス可能なキュー
特徴:
- インデックスベースアクセス
- 高速な要素操作
```

## Controllers 名前空間

### CameraController
```
役割: カメラ操作の実装
操作方法:
- WASD: 移動
- マウス: 回転
- E/Q: 上下移動
- Left Shift: 高速移動
- C: 低速移動
設定項目:
- speed: 移動速度
- mouseSensitivity: マウス感度
```

### PreviewObject
```
役割: プレビュー表示制御
機能:
- バウンディングボックス描画
- ポイント表示/非表示切り替え
- プレビュー更新制御
```

## Edl 名前空間

### EdlCamera
```
役割: Eye Dome Lighting用カメラ
機能:
- ポストプロセシング処理
- 深度バッファ解析
- 照明計算
- EDL/非EDL切り替え
```

### ViewCamera
```
役割: メインビューカメラ
機能:
- 標準的なカメラ処理
- EDLカメラとの連携
```

## シェーダーシステム

### レンダリング方式
1. **PointShader**: シンプルなポイントレンダリング
2. **QuadGeoShader**: ジオメトリシェーダー使用のクワッドレンダリング
3. **ParaboloidShader**: パラボロイド形状でのレンダリング
4. **EDL Shader**: Eye Dome Lighting専用シェーダー

### サイズ制御
- **ScreenSize**: スクリーン座標での固定サイズ
- **WorldSize**: ワールド座標での固定サイズ

## データフロー

```
1. PointCloudLoader → メタデータ読み込み
2. PointCloudLoader → 階層構造構築
3. PointCloudLoader → AbstractPointCloudSetに登録
4. AbstractPointCloudSet → AbstractRendererを起動
5. AbstractRenderer → カメラ情報に基づいてノード選択
6. AbstractRenderer → 必要なポイントデータを読み込み
7. AbstractRenderer → MeshConfigurationに基づいてGameObject生成
8. Unity → シェーダーでレンダリング実行
```

このアーキテクチャにより、小規模から大規模まで様々なサイズのポイントクラウドを効率的に表示できるシステムが実現されています。